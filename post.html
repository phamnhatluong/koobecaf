<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Chi tiết bài viết</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script>dayjs.extend(dayjs_plugin_relativeTime);</script>
    <link rel="stylesheet" href="account.css">
    <script src="theme.js" defer></script>
    <link rel="icon" href="https://ik.imagekit.io/mprhlnakz/image-11.png">
    <style>
      body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #000; color: #e4e6eb; }
      .card { background: #000; color: #fff; box-shadow: 0 4px 16px rgba(0,0,0,.3); border-radius: 16px; }
      body.light-mode .card { background: #fff !important; color: #000 !important; }
      .form-control { color: #fff; border: none; }
      body.light-mode { background: #fff !important; color: #000 !important; }
      .btn-like-on { border-color: transparent !important; }
    </style>
  </head>
  <body class="container py-4">
    <a href="index.html" class="btn btn-secondary mb-3">← Quay lại diễn đàn</a>
    <div id="postDetail" class="card p-3 mb-4"></div>

    <div>
      <h5>Bình luận</h5>
      <input id="commentInput" class="form-control mb-2" placeholder="Nhập bình luận..."/>
      <div id="commentList"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
      import {
        getFirestore, doc, getDoc, collection, query, orderBy, onSnapshot,
        addDoc, serverTimestamp, updateDoc
      } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

      // --- Firebase ---
      const firebaseConfig = {
        apiKey: "AIzaSyB1hj75YSToaR_RliGxoPAFyGXZVpFqTm4",
        authDomain: "we-are-always-here.firebaseapp.com",
        projectId: "we-are-always-here",
        storageBucket: "we-are-always-here.firebasestorage.app",
        messagingSenderId: "976166105043",
        appId: "1:976166105043:web:1ea3a17025c4df62148926",
        measurementId: "G-R8VN95690J"
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // --- Lấy postId từ URL ---
      const params = new URLSearchParams(location.search);
      const postId = params.get("id");
      const postDiv = document.getElementById("postDetail");
      const commentList = document.getElementById("commentList");

      // --- Lấy user từ localStorage, bắt buộc đăng nhập ---
      const rawUser = JSON.parse(localStorage.getItem("currentUser") || "{}");
      const currentUser = {
        uid: rawUser.uid || null,
        email: rawUser.email || null,
        username: rawUser.username || rawUser.email || "Ẩn danh",
        avatar: (rawUser.avatar && rawUser.avatar.startsWith("https"))
          ? rawUser.avatar
          : "https://i.pravatar.cc/100?u=default",
      };

      if (!currentUser.email) {
        // Chưa đăng nhập → quay về login
        window.location.href = "login.html";
      }

      // --- Đồng bộ username realtime (nếu có uid) ---
      if (currentUser.uid) {
        onSnapshot(doc(db, "users", currentUser.uid), (snap) => {
          if (snap.exists()) {
            const data = snap.data();
            if (data.username) {
              currentUser.username = data.username;
              localStorage.setItem("currentUser", JSON.stringify({
                ...rawUser,
                username: data.username
              }));
            }
          }
        });
      }

      // --- Load bài viết ---
      async function loadPost() {
        if (!postId) {
          postDiv.innerHTML = "<div class='alert alert-danger'>Không tìm thấy bài viết!</div>";
          return;
        }
        const snap = await getDoc(doc(db, "posts", postId));
        if (!snap.exists()) {
          postDiv.innerHTML = "<div class='alert alert-danger'>Bài viết không tồn tại!</div>";
          return;
        }
        const p = snap.data();
        postDiv.innerHTML = `
          <div class="d-flex align-items-center mb-2">
            <img src="${p.avatar || "https://i.pravatar.cc/100"}" class="rounded-circle me-2" style="width:40px;height:40px;">
            <div>
              <strong>${p.author || "Ẩn danh"}</strong><br>
              <small class="text-muted">${p.createdAt ? dayjs(p.createdAt.toDate()).fromNow() : ""}</small>
            </div>
          </div>
          <p>${p.content || ""}</p>
          ${p.imageUrl ? `<img src="${p.imageUrl}" class="img-fluid mb-3" style="border-radius:12px;box-shadow:0 1px 8px #0003;max-height:500px;object-fit: none;width:100%;">` : ""}
        `;
      }

      // --- Gửi bình luận bằng Enter ---
      document.getElementById("commentInput").addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          const content = e.target.value.trim();
          if (!content) return;
          const authorName = currentUser.username || currentUser.email;
          const authorId = currentUser.uid || currentUser.email;
          await addDoc(collection(db, "posts", postId, "comments"), {
            author: authorName,
            authorId,
            avatar: currentUser.avatar,
            content,
            createdAt: serverTimestamp(),
            likes: [],
          });
          e.target.value = "";
        }
      });

      // --- Load danh sách bình luận + reply ---
      function loadComments() {
        const q = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snap) => {
          commentList.innerHTML = "";
          snap.forEach((docSnap) => {
            const c = docSnap.data();
            const commentId = docSnap.id;

            const myId = currentUser.uid || currentUser.email;
            const liked = (c.likes || []).includes(myId);
            const likeCount = (c.likes || []).length;

            const div = document.createElement("div");
            div.className = "border rounded p-2 mb-2";
            div.innerHTML = `
              <div class="d-flex align-items-center mb-1">
                <img src="${c.avatar || "https://i.pravatar.cc/100"}" class="rounded-circle me-2" style="width:32px;height:32px;">
                <strong>${c.author || "Ẩn danh"}</strong>
                <small class="text-muted ms-2">${c.createdAt ? dayjs(c.createdAt.toDate()).fromNow() : ""}</small>
              </div>
              <div>${c.content || ""}</div>
              ${c.imageUrl ? `<img src="${c.imageUrl}" class="img-fluid rounded mt-2" style="max-height:200px;">` : ""}
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm ${liked ? "btn-danger btn-like-on" : "btn-outline-danger"}"
                        onclick="toggleCommentLike('${commentId}')">❤️ (${likeCount})</button>
                <button class="btn btn-sm btn-outline-primary" onclick="showReplyBox('${commentId}')">↩️ Phản hồi</button>
              </div>
              <div id="reply-box-${commentId}" class="mt-2"></div>
              <div id="replies-${commentId}" class="mt-2 ps-4 border-start"></div>
            `;
            commentList.appendChild(div);

            loadReplies(commentId);
          });
        });
      }

      // --- Mở ô nhập reply ---
      window.showReplyBox = function (commentId) {
        const box = document.getElementById(`reply-box-${commentId}`);
        box.innerHTML = `
          <input class="form-control" placeholder="Nhập phản hồi..."
                 onkeydown="if(event.key==='Enter') sendReply('${commentId}', this)">
        `;
      };

      // --- Gửi reply ---
      window.sendReply = async function (commentId, input) {
        const text = input.value.trim();
        if (!text) return;
        const authorName = currentUser.username || currentUser.email;
        const authorId = currentUser.uid || currentUser.email;
        await addDoc(collection(db, "posts", postId, "comments", commentId, "replies"), {
          author: authorName,
          authorId,
          avatar: currentUser.avatar,
          content: text,
          createdAt: serverTimestamp(),
          likes: [],
        });
        input.value = "";
      };

      // --- Load replies theo comment ---
      function loadReplies(commentId) {
        const replyDiv = document.getElementById(`replies-${commentId}`);
        const q = query(collection(db, "posts", postId, "comments", commentId, "replies"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snap) => {
          replyDiv.innerHTML = "";
          snap.forEach((docSnap) => {
            const r = docSnap.data();
            const replyId = docSnap.id;

            const myId = currentUser.uid || currentUser.email;
            const liked = (r.likes || []).includes(myId);
            const likeCount = (r.likes || []).length;

            const div = document.createElement("div");
            div.className = "border rounded p-2 mb-2";
            div.innerHTML = `
              <div class="d-flex align-items-center mb-1">
                <img src="${r.avatar || "https://i.pravatar.cc/100"}" class="rounded-circle me-2" style="width:28px;height:28px;">
                <strong>${r.author || "Ẩn danh"}</strong>
                <small class="text-muted ms-2">${r.createdAt ? dayjs(r.createdAt.toDate()).fromNow() : ""}</small>
              </div>
              <div>${r.content || ""}</div>
              <button class="btn btn-sm ${liked ? "btn-danger btn-like-on" : "btn-outline-danger"} mt-2"
                      onclick="toggleReplyLike('${commentId}', '${replyId}')">❤️ (${likeCount})</button>
            `;
            replyDiv.appendChild(div);
          });
        });
      }

      // --- Toggle like cho comment ---
      window.toggleCommentLike = async function (commentId) {
        const ref = doc(db, "posts", postId, "comments", commentId);
        const snap = await getDoc(ref);
        if (!snap.exists()) return;

        const data = snap.data();
        let likes = Array.isArray(data.likes) ? [...data.likes] : [];
        const myId = currentUser.uid || currentUser.email;

        const i = likes.indexOf(myId);
        if (i >= 0) likes.splice(i, 1); else likes.push(myId);

        await updateDoc(ref, { likes });
      };

      // --- Toggle like cho reply ---
      window.toggleReplyLike = async function (commentId, replyId) {
        const ref = doc(db, "posts", postId, "comments", commentId, "replies", replyId);
        const snap = await getDoc(ref);
        if (!snap.exists()) return;

        const data = snap.data();
        let likes = Array.isArray(data.likes) ? [...data.likes] : [];
        const myId = currentUser.uid || currentUser.email;

        const i = likes.indexOf(myId);
        if (i >= 0) likes.splice(i, 1); else likes.push(myId);

        await updateDoc(ref, { likes });
      };

      // --- Khởi chạy ---
      loadPost();
      loadComments();
    </script>
  </body>
</html>
